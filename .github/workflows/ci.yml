name: Spring Boot CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build-user-service:
    name: Build User Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          cd srv/user-service
          ./mvnw -B clean install
      
      - name: Run tests
        run: |
          cd srv/user-service
          ./mvnw test
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: user-service-jar
          path: srv/user-service/target/*.jar

  build-event-service:
    name: Build Event Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          cd srv/event-service
          ./mvnw -B clean install
      
      - name: Run tests
        run: |
          cd srv/event-service
          ./mvnw test
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: event-service-jar
          path: srv/event-service/target/*.jar

  build-booking-service:
    name: Build Booking Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          cd srv/booking-service
          ./mvnw -B clean install
      
      - name: Run tests
        run: |
          cd srv/booking-service
          ./mvnw test
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: booking-service-jar
          path: srv/booking-service/target/*.jar

  build-search-service:
    name: Build Search Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          cd srv/search
          ./mvnw -B clean install
      
      - name: Run tests
        run: |
          cd srv/search
          ./mvnw test
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: search-service-jar
          path: srv/search/target/*.jar

  build-dashboard-service:
    name: Build Dashboard Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          cd srv/dashboard-service
          ./mvnw -B clean install
      
      - name: Run tests
        run: |
          cd srv/dashboard-service
          ./mvnw test
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-service-jar
          path: srv/dashboard-service/target/*.jar

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-user-service, build-event-service, build-booking-service, build-search-service, build-dashboard-service]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "âœ… All microservices built successfully!"
          echo "User Service: ${{ needs.build-user-service.result }}"
          echo "Event Service: ${{ needs.build-event-service.result }}"
          echo "Booking Service: ${{ needs.build-booking-service.result }}"
          echo "Search Service: ${{ needs.build-search-service.result }}"
          echo "Dashboard Service: ${{ needs.build-dashboard-service.result }}"
